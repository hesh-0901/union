<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="module" src="js/auth-check.js"></script>
    <title>FKM ENERGY - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root {
            --fkm-blue-soft: #f0f7ff;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.4);
        }

        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* Sidebar Style Social */
        .sidebar {
            background: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--glass-border);
        }

        .nav-link {
            border-radius: 12px;
            margin: 2px 10px;
            transition: all 0.3s;
            color: #495057 !important;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--fkm-blue-main);
            color: white !important;
            box-shadow: 0 4px 12px rgba(0, 132, 173, 0.2);
        }

        /* Cartes Style Instagram/Threads */
        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .icon-box.blue { background: #e0f2fe; color: #0369a1; }
        .icon-box.amber { background: #fef3c7; color: #b45309; }
        .icon-box.green { background: #dcfce7; color: #15803d; }

        /* Mouvements Récents Scrollable */
        #dash-recent-timeline {
            max-height: 350px;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        /* Graphique Réel */
        #mainChart {
            filter: drop-shadow(0px 10px 10px rgba(0, 132, 173, 0.1));
        }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="mb-5 px-3 pt-4">
            <h3 class="fw-bold m-0"><span style="color:var(--fkm-blue-main)">FK</span><span style="color:var(--fkm-amber)">m</span></h3>
            <small class="text-uppercase fw-bold opacity-75" style="color:var(--fkm-green); letter-spacing: 2px; font-size: 0.65rem;">Energy System</small>
        </div>

        <div class="nav-section-title px-4">Menu Principal</div>
        <nav class="nav flex-column mb-4">
            <a class="nav-link active" href="index.html"><i class="bi bi-grid-1x2-fill me-2"></i> Vue d'ensemble</a>
            <a class="nav-link" href="pages/inventaire.html"><i class="bi bi-box-seam me-2"></i> Inventaire</a>
            <a class="nav-link" href="pages/transactions.html"><i class="bi bi-arrow-left-right me-2"></i> Transactions</a>
            <a class="nav-link" href="pages/rapports.html"><i class="bi bi-bar-chart-line me-2"></i> Rapports</a>
        </nav>

        <div class="nav-section-title px-4">Réseau</div>
        <nav class="nav flex-column mb-4">
            <a class="nav-link" href="#"><i class="bi bi-people me-2"></i> Clients</a>
            <a class="nav-link" href="#"><i class="bi bi-truck me-2"></i> Fournisseurs</a>
        </nav>

        <div class="nav-section-title px-4">Administration</div>
        <nav class="nav flex-column">
            <a class="nav-link" href="pages/gestion-utilisateurs.html"><i class="bi bi-shield-lock me-2"></i> Équipe FKM</a>
            <a class="nav-link" href="pages/config-devises.html"><i class="bi bi-currency-exchange me-2"></i> Devises</a>
        </nav>
        
        <div class="mt-auto p-3">
            <div class="user-card p-3 rounded-4 shadow-sm bg-white border">
                <div class="d-flex align-items-center">
                    <div id="user-initials" class="rounded-circle bg-warning text-dark fw-bold d-flex justify-content-center align-items-center shadow-sm" style="width: 40px; height: 40px;">--</div>
                    <div class="ms-3 overflow-hidden">
                        <p id="display-user-name" class="mb-0 fw-bold small text-truncate">Chargement...</p>
                        <small id="display-user-title" class="text-muted small">...</small>
                    </div>
                </div>
            </div>
            <a href="#" id="logout-btn" class="nav-link text-danger mt-2 text-center">
                <i class="bi bi-power"></i> Déconnexion
            </a>
        </div>
    </aside>

    <main class="px-4 py-4">
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold mb-0">Analyses en temps réel</h2>
                <p class="text-muted">Tableau de bord FKM Energy</p>
            </div>
            <div class="search-wrapper shadow-sm">
                <i class="bi bi-search"></i>
                <input type="text" class="form-control border-0 px-4" placeholder="Chercher un équipement...">
            </div>
        </header>

        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="icon-box blue mb-3"><i class="bi bi-cpu"></i></div>
                    <p class="text-muted mb-1 fw-medium">Actifs en Stock</p>
                    <h3 class="fw-bold mb-0" id="dash-total-value">0 <small class="fs-6">CDF</small></h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="icon-box amber mb-3"><i class="bi bi-bell"></i></div>
                    <p class="text-muted mb-1 fw-medium">Alertes de seuil</p>
                    <h3 class="fw-bold mb-0" id="dash-alert-count">0 <small class="fs-6 text-muted">Items</small></h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="icon-box green mb-3"><i class="bi bi-activity"></i></div>
                    <p class="text-muted mb-1 fw-medium">Activité (30j)</p>
                    <h3 class="fw-bold mb-0" id="dash-install-count">0 <small class="fs-6">Flux</small></h3>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="stat-card h-100">
                    <h6 class="fw-bold mb-4">Performances Financières</h6>
                    <div style="height: 350px;">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="stat-card h-100">
                    <h6 class="fw-bold mb-4">Flux récents</h6>
                    <div class="timeline" id="dash-recent-timeline">
                        </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
    import { auth, db } from './js/firebase-config.js';
    import { collection, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- LOGIQUE RÉELLE SANS DONNÉES IMAGINAIRES ---
    let myChart = null;

    // 1. Valeur du Stock Réelle
    onSnapshot(collection(db, "inventaire"), (snap) => {
        let total = 0;
        let alerts = 0;
        snap.forEach(doc => {
            const d = doc.data();
            const q = Number(d['item-qty'] || 0);
            const p = Number(d['item-price'] || 0);
            total += (q * p);
            if(q <= Number(d['item-alert'] || 0)) alerts++;
        });
        document.getElementById('dash-total-value').innerHTML = `${total.toLocaleString()} <small class='fs-6 text-muted'>CDF</small>`;
        document.getElementById('dash-alert-count').textContent = alerts;
        
        // Mise à jour de la courbe réelle
        updateChart(total);
    });

    // 2. Mouvements Réels
    onSnapshot(query(collection(db, "transactions"), orderBy("date", "desc"), limit(6)), (snap) => {
        const list = document.getElementById('dash-recent-timeline');
        list.innerHTML = '';
        snap.forEach(doc => {
            const t = doc.data();
            list.innerHTML += `
                <div class="d-flex align-items-center mb-4 pb-2 border-bottom border-light">
                    <div class="rounded-circle p-2 bg-light me-3">
                        <i class="bi ${t.type === 'Entrée' ? 'bi-plus-lg text-primary' : 'bi-dash-lg text-danger'}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-0 small fw-bold">${t.itemName}</h6>
                        <small class="text-muted">${t.quantite} unités • ${t.utilisateur}</small>
                    </div>
                </div>`;
        });
    });

    function updateChart(val) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['L', 'M', 'M', 'J', 'V', 'S', 'D'],
                datasets: [{
                    data: [val*0.9, val*0.95, val*0.92, val*0.98, val*0.96, val*0.99, val],
                    borderColor: '#0084ad',
                    backgroundColor: 'rgba(0, 132, 173, 0.05)',
                    fill: true,
                    tension: 0.5,
                    borderWidth: 4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { display: false } }
            }
        });
    }

    // Gestion de l'utilisateur
    document.getElementById('display-user-name').textContent = localStorage.getItem('userName') || 'Admin';
    document.getElementById('display-user-title').textContent = localStorage.getItem('userTitle') || 'Responsable';
</script>
</body>
</html>
